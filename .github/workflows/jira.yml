name: jira integration

on:
  create:
    types:
      - branch

  pull_request_target:
    types: [opened, closed]

  push:
    branches:
      - '*'

jobs:
  jira-branch:
    name: create new branch
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch' && contains(github.server_url, 'gitea')

    steps:
      - name: transition to in progress on branch event
        uses: appleboy/jira-action@v0.2.0
        with:
          base_url: https://mtkjira
          insecure: true
          token: ${{ secrets.JIRA_TOKEN }}
          ref: ${{ github.ref_name }}
          transition: Start Progress
          assignee: ${{ github.actor }}

  open-pull-request:
    name: transition to in review when pull request is created
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened' && contains(github.server_url, 'gitea')

    steps:
      - name: transition to in review when pull request is created
        uses: appleboy/jira-action@v0.2.0
        with:
          base_url: https://mtkjira
          insecure: true
          token: ${{ secrets.JIRA_TOKEN }}
          ref: ${{ github.event.pull_request.title }}
          transition: Finish Coding
          comment: |
            üîß [~${{ github.event.pull_request.user.login }}] {color:#00875A}*${{ github.event.pull_request.state }}*{color} pull request from repository {color:#ff8b00}*${{ github.repository }}*{color} {color:#00875A}*${{ github.event.pull_request.head.ref }}*{color} to {color:#00875A}*${{ github.event.pull_request.base.ref }}*{color}.

            See the detailed information from [pull request link|${{ github.event.pull_request.html_url }}].

            Pull request: *${{ github.event.pull_request.title }}*

  closed-pull-request:
    name: closed pull request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == false && contains(github.server_url, 'gitea')

    steps:
      - name: closed pull request
        uses: appleboy/jira-action@v0.2.0
        with:
          base_url: https://mtkjira
          insecure: true
          token: ${{ secrets.JIRA_TOKEN }}
          ref: ${{ github.event.pull_request.title }}
          comment: |
            üîíÔ∏è [~${{ github.event.pull_request.user.login }}] {color:#de350b}*${{ github.event.pull_request.state }}*{color} pull request from repository {color:#ff8b00}*${{ github.repository }}*{color} {color:#00875A}*${{ github.event.pull_request.head.ref }}*{color} to {color:#00875A}*${{ github.event.pull_request.base.ref }}*{color}.

            See the detailed information from [pull request link|${{ github.event.pull_request.html_url }}].

            Pull request: *${{ github.event.pull_request.title }}*

  jira-push-event:
    name: transition to in progress on push event
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.server_url, 'gitea')

    steps:
      - name: transition to in progress on push event
        uses: appleboy/jira-action@v0.2.0
        with:
          base_url: https://mtkjira
          insecure: true
          token: ${{ secrets.JIRA_TOKEN }}
          ref: ${{ github.event.head_commit.message }}
          transition: Start Progress
          assignee: ${{ github.event.head_commit.author.username }}
          comment: |
            üßë‚Äçüíª [~${{ github.event.pusher.username }}] push code to repository {color:#ff8b00}*${{ github.repository }}*{color} {color:#00875A}*${{ github.ref }}*{color} branch.

            See the detailed information from [commit link|${{ github.event.head_commit.url }}].

            ${{ github.event.head_commit.message }}

  jira-merge-request:
    name: transition to Merge and Deploy
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged }} && contains(github.server_url, 'gitea')

    steps:
      - name: transition to in review
        uses: appleboy/jira-action@v0.2.0
        with:
          base_url: https://mtkjira
          insecure: true
          token: ${{ secrets.JIRA_TOKEN }}
          ref: ${{ github.event.pull_request.title }}
          transition: Merge and Deploy
          resolution: Fixed
          comment: |
            üîÄ [~${{ github.event.pull_request.merged_by.login }}] {color:#00875A}*merged*{color} pull request from repository {color:#ff8b00}*${{ github.repository }}*{color} {color:#00875A}*${{ github.event.pull_request.head.ref }}*{color} branch to {color:#00875A}*${{ github.event.pull_request.base.ref }}*{color} branch.

            See the detailed information from [pull request link|${{ github.event.pull_request.html_url }}].

            Pull request: *${{ github.event.pull_request.title }}*
